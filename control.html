<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Control - Autoware Developer Guide fron NEWSLAB, NTU</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="dev-env.html"><strong aria-hidden="true">1.</strong> Development Environment</a></li><li class="chapter-item expanded "><a href="build-autoware.html"><strong aria-hidden="true">2.</strong> Build Autoware</a></li><li class="chapter-item expanded "><a href="customization.html"><strong aria-hidden="true">3.</strong> Customization</a></li><li class="chapter-item expanded "><a href="sensors.html"><strong aria-hidden="true">4.</strong> Sensors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sensors/velodyne-vlp32.html"><strong aria-hidden="true">4.1.</strong> LiDAR: Velodyne VLP-32C</a></li><li class="chapter-item expanded "><a href="sensors/blickfield-cube1.html"><strong aria-hidden="true">4.2.</strong> LiDAR: Blickfield Cube1</a></li><li class="chapter-item expanded "><a href="sensors/zed-x-mini.html"><strong aria-hidden="true">4.3.</strong> Camera: ZED X Mini</a></li></ol></li><li class="chapter-item expanded "><a href="perception.html"><strong aria-hidden="true">5.</strong> Perception</a></li><li class="chapter-item expanded "><a href="control.html" class="active"><strong aria-hidden="true">6.</strong> Control</a></li><li class="chapter-item expanded "><a href="vehicle-config.html"><strong aria-hidden="true">7.</strong> Vehicle Configuration</a></li><li class="chapter-item expanded "><a href="map-and-localization.html"><strong aria-hidden="true">8.</strong> Map &amp; Localization</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Autoware Developer Guide fron NEWSLAB, NTU</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="control"><a class="header" href="#control">Control</a></h2>
<p>The controller module is one of the most diverse part in Autoware.
That's because the controlling mechanism is vehicle-specific.
Petrol-driven cars have pedals. Electric cars adopts electronic
stability controller (ESC). Small battery-driven cars use PWM
controller. Hence, there is no common interface for low-level control.</p>
<p>Autoware does not assume the controlling mechanism, but sends commands
in <code>autoware_auto_control_msgs/AckermannControlCommand</code> type, which
include the target speed and target acceleration, etc. A vehicle driver
node must be implemented to convert these commands to low-level
controlling commands.</p>
<p>Autoware defaults to the PACMod protocol over CANbus to send commands.
Unfortunately, it is available only on a handful of vehicles
(<a href="https://autonomoustuff.atlassian.net/wiki/spaces/PACMod/pages/1510604805/Vehicle+Platform+PACMod+Compatibility">link</a>).
There are chances that you write your vehicle driver.</p>
<h2 id="example-artc-canbus"><a class="header" href="#example-artc-canbus">Example: ARTC CANbus</a></h2>
<p>To communicate with CAN bus network, we mainly have two ways:
Firstly, use the <code>ros2_socketcan</code> ROS package which provided by AWF.
It creates two topics: <code>from_can_bus</code> and <code>to_can_bus</code>, the former is
a topic to be subscribed to read CAN bus frame from the CAN bus
network and the latter is a topic to be published to write CAN bus
frame to CAN bus network. Note that you have to plugin your Kvaser
adapter before running the socketcan ROS package, and wake up your
Kvaser adapter by running the command:</p>
<pre><code class="language-bash">sudo modprobe can
sudo modprobe can_raw
sudo ip link set can0 type can bitrate 5000000
sudo ip link set up can0
</code></pre>
<p>The bitrate can be changed if needed.</p>
<p><img src="./media/media/UGMH5VBDV963V3NJJ1OGS1P65C.png" alt="" /></p>
<p>In order to use <code>ros2_socketcan</code> ROS package, we cannot preinstall
Leaf driver which vendored by Kvaser. Type <code>lsmod \| grep leaf</code> to
verify the installation of the Leaf driver, if you see the below
output message, then the system has installed Leaf driver.</p>
<p><img src="./media/media/K20A1LFOI930RE2QOR0BFF71QS.png" alt="" /></p>
<p>Secondly, use the Kvaser driver and corresponding APIs to
communicate with the CAN bus network. Visit this
 <a href="https://www.kvaser.com/canlib-webhelp/section_install_windows.html">link</a>
if you're using Windows. However, visit this
<a href="https://www.kvaser.com/canlib-webhelp/section_install_linux.html">link</a>
if you're running Linux. Next, choose the proper SDK and Kvaser
driver. After that, install the corresponding CANlib to control the
installed CAN driver. Take python as an example, run <code>pip install canlib</code> to install python wrapper for Kvaser CANlib. After
installation, you can run below sample python script to verify all
installation are working. If CANlib and driver working, your Kvaser
adapter information should be printed out.</p>
<p><img src="./media/media/CNE8AAIB5L7NV6DPIBPKV4D7IO.png" alt="" /></p>
<p>Note that you have to plugin your Kvaser adapter before running the
python script.</p>
<p>Every vehicle has its own specific CAN bus communication
protocol. Thus, in order to use CAN bus communication to operate the
vehicle, you must have the appropriate CAN message map in order to
send the proper CAN bus control command to the CAN bus network. The
PID controller assists in achieving smooth throttle and brake control,
which is necessary to replicate human driving behavior. If you are
using python for development the control logic, you can install
simple-pid package using <code>pip install simple-pid</code> command to use the
PID controller. To leverage PID controller, your vehicle needs to be
able to retrieve the vehicle's current state, e.g., current speed of
the vehicle, current acceleration of vehicle, current steering angle
of vehicle, etc. You can set your setpoint(SP) and calculate the next
step value with the current status of vehicle. After a while, the
vehicle status will approach to the SP smoothly. Note that PID
controllers need to be tuned for individual type of vehicle.</p>
<p>TODO(ykming)</p>
<p>SocketCAN, kvaser, PID controller</p>
<h2 id="example-f1eigth-esc-controller"><a class="header" href="#example-f1eigth-esc-controller">Example: F1EIGTH ESC Controller</a></h2>
<p>A script is provided by the manufacturer for controlling F1EIGTH car
using a terminal interface. It utilized Adafruit's PCA9685 library to
manage the steering servo and the Electronic Speed Controller
(ESC). The user can control acceleration, braking, and steering via
keyboard inputs. The code also includes an interface for displaying
speed and steering angle updates and features for initiating and
terminating the program.</p>
<p>The code primarily revolves around the concept of Pulse Width
Modulation (PWM), which is crucial for controlling the speed of motors
and the position of servos in remote-controlled cars. The Adafruit
PCA9685 library used in the script allows for precise control over PWM
signals.  This is essential for adjusting the speed of the car's motor
(through the ESC) and the angles of the steering servo. The
<code>pwm.set_pwm_freq()</code> function sets the frequency of the PWM signal,
and <code>pwm.set_pwn()</code> is used to specify the channel, on-time, and
off-time of the PWM signal, directly influencing motor speed and servo
position. This integration of software and hardware illustrates the
advanced control capabilities provided for remote-controlled vehicles.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="perception.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="vehicle-config.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="perception.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="vehicle-config.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
